aliases:
  - &restore-gradle-cache
    keys:
      - v1-dependencies-{{ checksum "build.gradle" }}
      # fallback to using the latest cache if no exact match is found
      - v1-dependencies-

  - &save-gradle-cache
    paths:
      - ~/.gradle
    key: v1-dependencies-{{ checksum "build.gradle" }}

  - &gradle-env
    GRADLE_OPTS: -Dorg.gradle.daemon=false

  - &restore-maven-cache
    keys:
        # when lock file changes, use increasingly general patterns to restore cache
        - maven-repo-v1-{{ .Branch }}-{{ checksum "pom.xml" }}
        - maven-repo-v1-{{ .Branch }}-
        - maven-repo-v1-

  - &save-maven-cache
    paths:
      - ~/.m2
    key: maven-repo-v1-{{ .Branch }}-{{ checksum "pom.xml" }}

defaults: &defaults
  working_directory: ~/repo
  docker:
    - image: dripstat/internal-java-mckey:maven-3.6.1
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASS
  environment:
    # Customize the JVM maximum heap limit
    JVM_OPTS: -Xmx3200m
    TERM: dumb

version: 2

workflows:
  version: 2

#  build-only:
#    jobs:
#    - build-plain:
#       filters:
#          branches:
#            only: /.*/

  maven-central-publish:
    jobs:
      - maven-publish:
          filters:
            branches:
              only: maven

#  publish-local:
#     jobs:
#     - build-publish-local:
#        filters:
#          branches:
#           ignore: master

  publish-prod-central:
       jobs:
       - build-publish-maven-central:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/

jobs:
  maven-publish:
    <<: *defaults
    steps:
      - checkout
      - restore_cache: *restore-maven-cache
      - run:
          command: |
            apt-get update && apt-get install -y gpg
            export GPG_TTY=$(tty)
            gpg --batch --import $SIGN_RINGFILE
            mvn --batch-mode deploy
      - save_cache: *save-maven-cache

  build-plain:
    <<: *defaults
    steps:
      - checkout
      - restore_cache: *restore-gradle-cache
      - run:
         environment: *gradle-env
         command: |
           chmod +x ./gradlew
           ./gradlew build

      - save_cache: *save-gradle-cache

  build-publish-local:
      <<: *defaults
      steps:
        - checkout
        - restore_cache: *restore-gradle-cache
        - run:
           environment: *gradle-env
           command: |
             chmod +x ./gradlew
             ./gradlew publishToMavenLocal -Psigning.keyId=$SIGN_KEY_ID -Psigning.password=$SIGN_PASS -Psigning.secretKeyRingFile=$SIGN_RINGFILE

        - save_cache: *save-gradle-cache

  build-publish-maven-central:
        <<: *defaults
        steps:
          - checkout
          - restore_cache: *restore-gradle-cache
          - run:
             environment: *gradle-env
             command: |
               chmod +x ./gradlew
               ./gradlew publish closeAndReleaseRepository -PnexusUsername=$NEXUS_USER -PnexusPassword=$NEXUS_PASS -Psigning.keyId=$SIGN_KEY_ID -Psigning.password=$SIGN_PASS -Psigning.secretKeyRingFile=$SIGN_RINGFILE

          - save_cache: *save-gradle-cache



